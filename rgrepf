#!/usr/bin/env bash

rgrepf () {
  if [ "$#" -ge 2 ]; then
    local shwordsplit="$(set -o | grep shwordsplit | awk '{print $2}')"
    [ "$shwordsplit" != "" -a "$shwordsplit" = "off" ] && setopt SH_WORD_SPLIT && shwordsplit="ENABLED"

    local OLD="$1"; shift
    local NEW="$1"; shift

    local INCLUDED_RAW=""
    local EXCLUDED_RAW=""
    if [ "$#" -gt 0 ]; then
      INCLUDED_RAW="$(echo "$@" | sed -n "s/\(.*\)::\(.*\)/\1/p" | xargs)"
      EXCLUDED_RAW="$(echo "$@" | sed -n "s/\(.*\)::\(.*\)/\2/p" | xargs)"
      [ "$INCLUDED_RAW" = "" -a "$EXCLUDED_RAW" = "" ] && INCLUDED_RAW="$@"
      [ "$INCLUDED_RAW" = "" -o "$INCLUDED_RAW" = "::" ] && INCLUDED_RAW=""
    fi
    local ARRAY DIRS FILES
    local INCLUDED_DIRS INCLUDED_FILES
    local EXCLUDED_DIRS EXCLUDED_FILES
    ARRAY=($INCLUDED_RAW); DIRS=(); FILES=()
    for i in $ARRAY; do
      if [ "$(printf $i | tail -c1)" = "/" ]
      then DIRS+=("$(echo $i | sed 's/.$//')")
      else FILES+=("$i"); fi
    done
    [ "$DIRS" != "" ] && INCLUDED_DIRS="--include-dir={$(echo $DIRS | awk -v OFS="," '$1=$1' | sed 's/$/,/')}"
    [ "$FILES" != "" ] && INCLUDED_FILES="--include={$(echo $FILES | awk -v OFS="," '$1=$1' | sed 's/$/,/')}"
    ARRAY=($EXCLUDED_RAW); DIRS=(); FILES=()
    for i in $ARRAY; do
      if [ "$(printf $i | tail -c1)" = "/" ]
      then DIRS+=("$(echo $i | sed 's/.$//')")
      else FILES+=("$i"); fi
    done
    [ "$DIRS" != "" ] && EXCLUDED_DIRS="--exclude-dir={$(echo $DIRS | awk -v OFS="," '$1=$1' | sed 's/$/,/')}"
    [ "$FILES" != "" ] && EXCLUDED_FILES="--exclude={$(echo $FILES | awk -v OFS="," '$1=$1' | sed 's/$/,/')}"

    # echo "grep -rEIl --null \"$OLD\" * $INCLUDED_DIRS $INCLUDED_FILES $EXCLUDED_DIRS $EXCLUDED_FILES | xargs -0 perl -pi -e \"s@$OLD@$NEW@g\""
    eval "grep -rEIl \"$OLD\" * $INCLUDED_DIRS $INCLUDED_FILES $EXCLUDED_DIRS $EXCLUDED_FILES | xargs perl -pi -e \"s@$OLD@$NEW@g\""

    eval "grep -rEIHn --context=3 --color=always -e \"$NEW\" * $INCLUDED_DIRS $INCLUDED_FILES $EXCLUDED_DIRS $EXCLUDED_FILES | less -RiMSFX#4"

    [ "$shwordsplit" = "ENABLED" ] && unsetopt SH_WORD_SPLIT
  else
    echo "   Usage: rgrepf <old> <new> [INCLUDED...] [:: EXCLUDED...]"
    echo
    echo "   Search and replace <old> with <new> in <INCLUDED> files, ignoring <EXCLUDED> files."
    echo "   <INCLUDED> files are separated from <EXCLUDED> files by a '::'."
    echo "   When omitted, <INCLUDED> is the current dir and <EXCLUDED> is empty."
    echo "   Note: If '@' appears in <old> or <new>, it must be escaped i.e. '\\@'"
    echo
    echo "   Examples:"
    echo "      rgrepf old new"
    echo "      rgrepf old new *.py"
    echo "      rgrepf old new file1.txt folder1/ :: folder1/file2.txt"
    echo "      rgrepf old new :: file1.txt **/*.log"
  fi
}
